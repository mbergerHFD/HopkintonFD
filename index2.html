<!DOCTYPE html>
<html>
  <head>
    <title>Pre Fire Plans</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>

    <style>
      body { padding: 20px 40px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
      #example tbody tr { cursor: pointer; }
      #example tbody tr:hover { background: #f4f6f8; }

      dialog.modal {
        width: min(960px, 92vw);
        border: none; border-radius: 14px; padding: 0;
        box-shadow: 0 24px 72px rgba(0,0,0,.35);
      }
      dialog::backdrop { background: rgba(0,0,0,.55); }

      .modal__header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 16px 20px; border-bottom: 1px solid #e5e7eb;
      }
      .modal__title { margin: 0; font-size: 18px; font-weight: 700; }
      .modal__body { padding: 16px 20px 20px; max-height: min(70vh, 70svh); overflow: auto; }

      .hero { margin: 0 0 12px; }
      .hero-box {
        width: 50%;
        margin: 0 auto;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        max-height: 150px;
      }
      .hero-box img { display: block; width: 100%; height: auto; max-height: 150px; object-fit: contain; }
      .hero-box .drive-frame { width: 100%; height: 150px; border: 0; }
      .hero__caption { margin-top: 6px; font-size: 12px; color: #6b7280; }

      .kv {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: 8px 16px;
        align-items: start;
      }
      .kv dt { font-weight: 600; color: #374151; background: #f8fafc; padding: 8px 10px; border-radius: 8px; }
      .kv dd { margin: 0; background: #fff; border: 1px solid #e5e7eb; padding: 8px 12px; border-radius: 8px; word-break: break-word; }

      .chips { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
      .chip {
        font-size: 14px; padding: 8px 12px; border-radius: 999px;
        background: #eef2ff; color: #1d4ed8; border: 2px solid #c7d2fe;
      }

      @media (max-width: 640px) {
        .kv { grid-template-columns: 1fr; }
        .kv dt { background: transparent; padding: 0; }
        .kv dd { padding: 10px 12px; }
      }

      /* Thumbs */
      img.thumb {
        height: 48px; max-width: 160px; object-fit: cover; border-radius: 6px;
        background: #f1f5f9; border: 1px solid #e5e7eb;
      }
    </style>
  </head>
  <body>
    <h1>Pre Fire Plans</h1>

    <table id="example" class="display" style="width:100%">
      <thead>
        <tr>
          <th>Photo:</th>
          <th>Business Name:</th>
          <th>Address:</th>
          <th>Closest Hydrant:</th>
          <th>Knox Box Location:</th>
          <th>Other Key Box Location:.</th>
          <th>Contact Name (1):</th>
          <th>Contact Number (1):</th>
          <th>Number of Stories:</th>
          <th>Occupancy</th>
          <th>Occupancy Notes:</th>
        </tr>
      </thead>
    </table>

    <!-- Modal -->
    <dialog id="rowModal" class="modal" aria-labelledby="modalTitle" aria-modal="true">
      <div class="modal__header">
        <h2 id="modalTitle" class="modal__title">Details</h2>
        <button class="modal__close" aria-label="Close">&times;</button>
      </div>
      <div class="modal__body">
        <div class="chips" id="chips"></div>
        <figure class="hero" id="hero" hidden>
          <div class="hero-box" id="heroBox"></div>
          <figcaption class="hero__caption" id="heroCaption"></figcaption>
        </figure>
        <dl class="kv" id="kv"></dl>
      </div>
    </dialog>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
      const VISIBLE_COLUMNS = [
        { key: 'Photo:' },
        { key: 'Business Name:' },
        { key: 'Address:' },
        { key: 'Closest Hydrant:' },
        { key: 'Knox Box Location:' },
        { key: 'Other Key Box Location:.' },
        { key: 'Contact Name (1):' },
        { key: 'Contact Number (1):' },
        { key: 'Number of Stories:' },
        { key: 'Occupancy' },
        { key: 'Occupancy Notes:' }
      ];

      const MODAL_KEYS = [
        'Business Name:','Address:','Closest Hydrant:','Photo:','Knox Box Location:','Other Key Box Location:.',
        'Contact Name (1):','Contact Number (1):','Contact Name (2):','Contact Number (2)',
        'Number of Stories:','Occupancy:','Occupancy Notes:','Construction Type:','Construction Type Notes:',
        'Roof Type:','Basement:','Roof Access Location:','Number of Elevators:','Elevator Locations:',
        'Elevator Type:','Elevator Notes:','Alarm Type:','Alarm Location:','Remote Alarm Location:',
        'Alarm Notes:','Elevator Shutoff Location:','Gas Shutoff Location:','Electrical Shutoff Location:',
        'Water Shutoff Location:','Sprinkler Main Shutoff Location:','Fire Pump Location:','Tanks:',
        'Combustibles:','Gas:','Haz-Mat:','Other:'
      ];

      const TRANSPARENT_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="160" height="48"></svg>');

      function isDriveLink(url) { return /drive\.google\.com/i.test(url); }
      function getDriveId(url) {
        if (!url) return '';
        let m = url.match(/drive\.google\.com\/file\/d\/([^/]+)\//i);
        if (m && m[1]) return m[1];
        m = url.match(/[?&]id=([^&]+)/i);
        if (m && m[1]) return m[1];
        return '';
      }

      function extractPhotoUrl(photoURL, photoCellText) {
        if (photoURL && /^https?:\/\//i.test(photoURL)) return photoURL;
        if (!photoCellText) return '';
        const s = String(photoCellText).trim();
        let m = s.match(/HYPERLINK\(\s*"([^"]+)"\s*,?\s*"(?:[^"]+)"\)/i); // Excel HYPERLINK("url","text")
        if (m && m[1]) return m[1];
        if (/^https?:\/\//i.test(s)) return s;
        m = s.match(/href="([^"]+)"/i);
        if (m && m[1]) return m[1];
        return '';
      }

      function getValue(row, keyWithColon) {
        const noColon = keyWithColon.replace(/:$/, '');
        return row[keyWithColon] ?? row[noColon] ?? '';
      }

      const columns = VISIBLE_COLUMNS.map(c => {
        if (c.key === 'Photo:') {
          return {
            data: null,
            orderable: false,
            title: 'Photo:',
            render: (data, type, row) => {
              const raw = extractPhotoUrl(row['PhotoURL'], row['Photo:']);
              if (!raw) return '';
              if (type !== 'display') return raw;
              if (isDriveLink(raw)) {
                const id = getDriveId(raw);
                if (!id) return '';
                const thumb = 'https://drive.google.com/thumbnail?id=' + encodeURIComponent(id) + '&sz=w180';
                return '<img class="thumb lazy" alt="photo" src="' + TRANSPARENT_SVG + '" data-src="' + thumb + '" />';
              }
              return '<img class="thumb lazy" alt="photo" src="' + TRANSPARENT_SVG + '" data-src="' + raw + '" onerror="this.closest(\'td\').textContent=\'Open photo\'" />';
            }
          };
        }
        if (c.key === 'Contact Number (1):') {
          return {
            data: function (row, type) {
              return row['Contact Number (1):'] ?? row['Contact Number (1)'] ?? '';
            },
            title: 'Contact Number (1):'
          };
        }
        return { data: c.key, title: c.key };
      });

      const table = new DataTable('#example', {
        ajax: 'https://script.google.com/macros/s/AKfycbw03c7Rrm_7oweQJUiprYdF5FXDzRRiYO3WjI97Nezq-D1GOQ69UPzRZNibGai7WL52Rg/exec',
        columns,
        pageLength: 15,
        deferRender: true,
        autoWidth: false,
        processing: true,
        dom: 'ftip' // include Filter (search), Table, Info, Pagination
      });

      // Set placeholder on search box once table is initialized
      $(table.table().node()).on('init.dt', function () {
        const input = document.querySelector('div.dataTables_filter input[type="search"]');
        if (input) {
          input.placeholder = 'Search name, address, hydrant, occupancy...';
          input.setAttribute('aria-label', 'Search table');
          input.style.minWidth = '320px';
        }
      });

      // Lazy loader for thumbnails (runs after each draw)
      const io = ('IntersectionObserver' in window) ? new IntersectionObserver(entries => {
        entries.forEach(e => {
          if (e.isIntersecting) {
            const img = e.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
            }
            io.unobserve(img);
          }
        });
      }, { root: null, rootMargin: '200px' }) : null;

      $('#example').on('draw.dt', function () {
        document.querySelectorAll('img.lazy[data-src]').forEach(img => {
          if (io) io.observe(img);
          else { img.src = img.dataset.src; img.removeAttribute('data-src'); }
        });
      });

      // Modal behavior
      const modal = document.getElementById('rowModal');
      const kv = document.getElementById('kv');
      const chips = document.getElementById('chips');
      const closeBtn = modal.querySelector('.modal__close');
      const hero = document.getElementById('hero');
      const heroBox = document.getElementById('heroBox');
      const heroCaption = document.getElementById('heroCaption');

      function openModalForRow(rowData) {
        const title = (getValue(rowData,'Business Name:') || getValue(rowData,'Address:') || 'Details').toString().trim();
        document.getElementById('modalTitle').textContent = title;

        // Chips (top): Closest Hydrant, Knox Box, Occupancy, Construction Type, Roof Type
        chips.innerHTML = '';
        const chipPairs = [
          ['Closest Hydrant:', getValue(rowData,'Closest Hydrant:')],
          ['Knox Box Location:', getValue(rowData,'Knox Box Location:')],
          ['Occupancy', rowData['Occupancy'] ?? rowData['Occupancy:']],
          ['Construction Type:', getValue(rowData,'Construction Type:')],
          ['Roof Type:', getValue(rowData,'Roof Type:')]
        ];
        chipPairs.forEach(([label, value]) => {
          if (value && String(value).trim()) {
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.textContent = label.replace(/:?$/, '') + ': ' + value;
            chips.appendChild(chip);
          }
        });

        // Hero (photo) preview
        heroBox.innerHTML = '';
        heroCaption.textContent = '';
        const raw = extractPhotoUrl(rowData['PhotoURL'], rowData['Photo:']);
        if (raw) {
          hero.hidden = false;
          if (isDriveLink(raw)) {
            const id = getDriveId(raw);
            const iframe = document.createElement('iframe');
            iframe.className = 'drive-frame';
            iframe.loading = 'lazy';
            iframe.referrerPolicy = 'no-referrer';
            iframe.src = 'https://drive.google.com/file/d/' + id + '/preview';
            heroBox.appendChild(iframe);
          } else {
            const img = document.createElement('img');
            img.alt = 'Photo';
            img.loading = 'lazy';
            img.src = raw;
            img.onerror = () => { heroCaption.textContent = 'Could not inline image. Open original in a new tab.'; };
            heroBox.appendChild(img);
          }
        } else {
          hero.hidden = true;
        }

        // Details list (full order)
        kv.innerHTML = '';
        MODAL_KEYS.forEach(k => {
          const v = getValue(rowData, k);
          if (v == null || String(v).trim() === '') return;
          const dt = document.createElement('dt'); dt.textContent = k.replace(/:$/, '');
          const dd = document.createElement('dd'); dd.textContent = v;
          kv.appendChild(dt); kv.appendChild(dd);
        });

        if (typeof modal.showModal === 'function') modal.showModal(); else modal.setAttribute('open', '');
      }

      $('#example tbody').on('click', 'tr', function () {
        const r = table.row(this);
        if (!r) return;
        const data = r.data();
        if (data) openModalForRow(data);
      });

      const modalEl = document.getElementById('rowModal');
      closeBtn.addEventListener('click', () => modalEl.close());
      modalEl.addEventListener('click', (e) => {
        const rect = modalEl.getBoundingClientRect();
        const inside = e.clientX >= rect.left && e.clientX <= rect.right &&
                       e.clientY >= rect.top  && e.clientY <= rect.bottom;
        if (!inside) modalEl.close();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modalEl.open) modalEl.close();
      });
    </script>
  </body>
</html>

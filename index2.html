<!DOCTYPE html>
<html>
	<head>
		<title>Pre Fire Plans</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
		<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css"/>

		<style>
			:root { --pad-x: 40px; }
			body { padding: 20px var(--pad-x); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
			h1 { text-align: center; margin: 0 0 10px; line-height: 1.2; }

			/* Red error banner (only shows on failure) */
			#dataError { display:none; margin:8px 0 12px; padding:10px 12px; border-radius:8px;
			background:#fef2f2; color:#991b1b; border:1px solid #fecaca; text-align:center; }

			/* Centered search bar */
			.dataTables_wrapper .dataTables_filter { text-align: center !important; float: none !important; margin: 8px 0 16px !important; }
			.dataTables_wrapper .dataTables_filter label { width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; }
			.dataTables_wrapper .dataTables_filter input[type="search"] {
				width: 100%; min-width: 320px; max-width: 720px; padding: 10px 12px;
				border-radius: 999px; border: 1px solid #d1d5db; outline: none;
			}
			.dataTables_wrapper .dataTables_filter input[type="search"]:focus {
				box-shadow: 0 0 0 3px rgba(59,130,246,0.25); border-color: #93c5fd;
			}

			/* Keep all columns visible: allow horizontal scroll */
			.dataTables_wrapper .dataTables_scroll { overflow: auto; }
			.dataTables_wrapper .dataTables_scrollBody { overflow-x: auto !important; }
			#example tbody tr { cursor: pointer; }
			#example tbody tr:hover { background: #f4f6f8; }

			/* Modal pinned near top */
			dialog.modal {
				position: fixed;
				inset: 5vh 0 auto 0;   /* top:5vh; centered horizontally via margin */
				margin: 0 auto;
				width: min(960px, 92vw);
				border: none; border-radius: 14px; padding: 0;
				box-shadow: 0 24px 72px rgba(0,0,0,.35);
			}
			dialog::backdrop { background: rgba(0,0,0,.55); }
			.modal__header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #e5e7eb; }
			.modal__title { margin: 0; font-size: 18px; font-weight: 700; }
			.modal__body { padding: 16px 20px 20px; max-height: min(70vh, 70svh); overflow: auto; }

			.chips { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 12px; justify-content: center; }
			.chip { font-size: 14px; padding: 8px 12px; border-radius: 999px; background: #eef2ff; color: #1d4ed8; border: 2px solid #c7d2fe; }

			.hero { margin: 0 0 12px; }
			.hero-box { width: 50%; margin: 0 auto; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; max-height: 150px; }
			.hero-box img { display: block; width: 100%; height: auto; max-height: 150px; object-fit: contain; }
			.hero-box .drive-frame { width: 100%; height: 150px; border: 0; }
			.hero__caption { margin-top: 6px; font-size: 12px; color: #6b7280; text-align: center; }

			.kv { display: grid; grid-template-columns: 240px 1fr; gap: 8px 16px; align-items: start; }
			.kv dt { font-weight: 600; color: #374151; background: #f8fafc; padding: 8px 10px; border-radius: 8px; }
			.kv dd { margin: 0; background: #fff; border: 1px solid #e5e7eb; padding: 8px 12px; border-radius: 8px; word-break: break-word; }

			img.thumb { height: 48px; max-width: 160px; object-fit: cover; border-radius: 6px; background: #f1f5f9; border: 1px solid #e5e7eb; }

			/* Inline photo previews in modal for * Photo: fields */
			.photo-dd { display: block; border: 0; padding: 0; background: transparent; }
			.photo-wrap { display: inline-block; max-width: 100%; border: 1px solid #e5e7eb; border-radius: 10px; background: #f8fafc; overflow: hidden; }
			.mini-photo { display: block; width: 100%; height: auto; max-height: 150px; object-fit: contain; }
			.photo-caption { font-size: 12px; color: #6b7280; margin-top: 4px; text-align: left; }

			@media (max-width: 640px) {
			:root { --pad-x: 14px; }
			.hero-box { width: 100%; }
			.kv { grid-template-columns: 1fr; }
			.kv dt { background: transparent; padding: 0; }
			.kv dd { padding: 10px 12px; }
			.chip { font-size: 12px; padding: 6px 10px; }
			table.dataTable { width: 100% !important; }
			}
			
			/* MOBILE TWEAKS */
			@media (max-width: 640px) {
				/* Let text wrap on small screens */
			table.dataTable td, table.dataTable th { white-space: normal !important; }
			table.dataTable tbody td, table.dataTable thead th { padding: 8px 10px; }
			/* Search input fits smaller screens */
			.dataTables_wrapper .dataTables_filter input[type="search"] { min-width: 0; max-width: 100%; }
			/* Modal uses most of the screen */
			dialog.modal { inset: 2vh 0 auto 0; width: 96vw; }
			.modal__body { max-height: 75vh; }
			/* Hero image block expands to full width */
			.hero-box { width: 100%; max-height: 150px; }
			img.thumb { height: 40px; max-width: 120px; }
			}
		</style>
	</head>
	<body>
		<h1>Hopkinton Fire Department<br>Pre Fire Plans</h1>
		<div id="dataError"></div>

		<div class="table-container">
			<table id="example" class="display" style="width:100%">
				<thead>
					<tr>
						<th>Photo:</th>
						<th>Business Name:</th>
						<th>Address:</th>
						<th>Closest Hydrant:</th>
						<th>Knox Box Location:</th>
					</tr>
				</thead>
			</table>
		</div>

		<!-- Modal -->
		<dialog id="rowModal" class="modal" aria-labelledby="modalTitle" aria-modal="true">
			<div class="modal__header">
				<h2 id="modalTitle" class="modal__title">Details</h2>
				<button class="modal__close" aria-label="Close">&times;</button>
			</div>
			<div class="modal__body">
				<div class="chips" id="chips"></div>
				<figure class="hero" id="hero" hidden>
				<div class="hero-box" id="heroBox"></div>
				<figcaption class="hero__caption" id="heroCaption"></figcaption>
				</figure>
				<dl class="kv" id="kv"></dl>
			</div>
		</dialog>

		<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
		<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
		<script>
			function showError(msg) {
				const b = document.getElementById('dataError');
				b.style.display = 'block';
				b.textContent = msg;
			}

			function isDriveLink(url) { return /drive\.google\.com/i.test(url); }
			function getDriveId(url) {
				if (!url) return '';
				let m = url.match(/drive\.google\.com\/file\/d\/([^/]+)\//i);
				if (m && m[1]) return m[1];
				m = url.match(/[?&]id=([^&]+)/i);
				if (m && m[1]) return m[1];
				return '';
			}

			function extractPhotoUrl(photoURL, photoCellText) {
				if (photoURL && /^https?:\/\//i.test(photoURL)) return photoURL;
				if (!photoCellText) return '';
				const s = String(photoCellText).trim();
				let m = s.match(/HYPERLINK\(\s*"([^"]+)"\s*,?\s*"(?:[^"]+)"\)/i);
				if (m && m[1]) return m[1];
				if (/^https?:\/\//i.test(s)) return s;
				m = s.match(/href="([^"]+)"/i);
				if (m && m[1]) return m[1];
				return '';
			}

			function getValue(row, keyWithColon) {
				const candidates = [
				keyWithColon,
				keyWithColon.replace(/:$/, ''),
				keyWithColon.replace(/:$/, ':.')
				];
				if (/^Haz-?Mat:$/i.test(keyWithColon)) {
					candidates.push('Haz-Mat:');
					candidates.push('Hazmat:');
				}
				for (const k of candidates) {
					if (Object.prototype.hasOwnProperty.call(row, k) && String(row[k]).trim() !== '') return row[k];
				}
				return '';
			}

			// Visible columns
			const VISIBLE_COLUMNS = [
			{ key: 'Photo:' },
			{ key: 'Business Name:' },
			{ key: 'Address:' },
			{ key: 'Closest Hydrant:' },
			{ key: 'Knox Box Location:' }
			];

			// Popup fields (full set)
			const MODAL_KEYS = [
			'Business Name:','Address:','Knox Box Location:','Other Key Box Location:','Closest Hydrant:',
			'Contact Name (1):','Contact Number (1):','Contact Name (2):','Contact Number (2):','Number of Stories:',
			'Occupancy:','Occupancy Notes:','Construction Type:','Construction Type Notes:','Roof Type:','Basement:',
			'Roof Access Location:','Roof Access Photo:','Number of Elevators:','Elevator Locations:','Elevator Type:','Elevator Notes:',
			'Alarm Type:','Alarm Location:','Alarm Photo:','Remote Alarm Location:','Alarm Notes:',
			'Elevator Shutoff Location:','Elevator Shutoff Photo:','Gas Shutoff Location:','Gas Shutoff Photo:',
			'Electrical Shutoff Location:','Electrical Shutoff Photo:','Water Shutoff Location:','Water Shutoff Photo:',
			'Sprinkler Main Shutoff Location:','Sprinkler Shutoff Photo:','Fire Pump Location:','Fire Pump Photo:',
			'Tanks:','Tanks Photo:','Combustibles:','Combustibles Photo:','Gas:','Gas Photo:','Haz-Mat:','Hazmat Photo:','Other:','Other Notes:'
			];

			// DataTables columns mapping
			const columns = VISIBLE_COLUMNS.map(c => {
				if (c.key === 'Photo:') {
					return {
						data: null,
						orderable: false,
						title: 'Photo:',
						render: (data, type, row) => {
							const raw = extractPhotoUrl(row['PhotoURL'], row['Photo:']);
							if (!raw) return '';
							if (type !== 'display') return raw;
							if (isDriveLink(raw)) {
								const id = getDriveId(raw);
								if (!id) return '';
								const thumb = 'https://drive.google.com/thumbnail?id=' + encodeURIComponent(id) + '&sz=w180';
								return '<img class="thumb" alt="photo" loading="lazy" src="' + thumb + '" />';
							}
							return '<img class="thumb" alt="photo" loading="lazy" src="' + raw + '" onerror="this.closest(\'td\').textContent=\'Open photo\'" />';
						}
					};
				}
				if (c.key === 'Contact Number (1):') {
					return {
						data: function (row) { return row['Contact Number (1):'] ?? row['Contact Number (1)'] ?? ''; },
						title: 'Contact Number (1):'
					};
				}
				if (c.key === 'Other Key Box Location:') {
					return {
						data: function (row) { return row['Other Key Box Location:'] ?? row['Other Key Box Location:.'] ?? ''; },
						title: 'Other Key Box Location:'
					};
				}
				if (c.key === 'Occupancy') {
					return {
						data: function (row) { return row['Occupancy'] ?? row['Occupancy:'] ?? ''; },
						title: 'Occupancy'
					};
				}
				return { data: c.key, title: c.key };
			});

			// Create DataTable with horizontal scroll (no column hiding)
			const table = new DataTable('#example', {
				columns,
				responsive: { details: false },
				columnDefs: [
				{ targets: 0, responsivePriority: 1 },   // Photo
				{ targets: 1, responsivePriority: 1 },   // Business Name
				{ targets: 2, responsivePriority: 2 },   // Address
				{ targets: 3, responsivePriority: 3 },   // Closest Hydrant
				{ targets: 4, responsivePriority: 4 }    // Knox Box
				],
				pageLength: 15,
				deferRender: true,
				autoWidth: false,
				processing: true,
				dom: 'ftip'
			});

			// Search placeholder
			$(table.table().node()).on('init.dt', function () {
				const input = document.querySelector('div.dataTables_filter input[type="search"]');
				if (input) { input.placeholder = 'Search name, address, hydrant, occupancy...'; input.setAttribute('aria-label','Search table'); }
			});

			// Fetch and normalize data
			const DATA_URL = 'https://script.google.com/macros/s/AKfycbw03c7Rrm_7oweQJUiprYdF5FXDzRRiYO3WjI97Nezq-D1GOQ69UPzRZNibGai7WL52Rg/exec';
			function normalizeRows(json) {
				if (!json) return [];
				if (Array.isArray(json)) return json;
				const keys = ['data','records','items','rows','result','values'];
				for (const k of keys) { if (Array.isArray(json[k])) return json[k]; }
				for (const k of Object.keys(json)) {
					const v = json[k];
					if (v && typeof v === 'object') {
						for (const kk of ['data','records','items','rows','result','values']) {
							if (Array.isArray(v[kk])) return v[kk];
						}
					}
				}
				return [];
			}

			fetch(DATA_URL, { credentials: 'omit' })
			.then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
			.then(json => {
				const rows = normalizeRows(json);
				if (!rows.length) showError('No rows returned from data source.');
				table.clear().rows.add(rows).draw();
			})
			.catch(err => { console.error(err); showError('Could not load data: ' + err.message); });

			// Modal behavior
			const modal = document.getElementById('rowModal');
			const kv = document.getElementById('kv');
			const chips = document.getElementById('chips');
			const hero = document.getElementById('hero');
			const heroBox = document.getElementById('heroBox');
			const heroCaption = document.getElementById('heroCaption');

			function openModalForRow(rowData) {
				// Reset scroll to top of page to avoid perceived offset
				window.scrollTo({ top: 0, behavior: 'instant' });

				const title = (getValue(rowData,'Business Name:') || getValue(rowData,'Address:') || 'Details').toString().trim();
				document.getElementById('modalTitle').textContent = title;

				chips.innerHTML = '';
				[['Closest Hydrant:', getValue(rowData,'Closest Hydrant:')],
				['Knox Box Location:', getValue(rowData,'Knox Box Location:')],
				['Occupancy', getValue(rowData,'Occupancy:') || rowData['Occupancy']],
				['Construction Type:', getValue(rowData,'Construction Type:')],
				['Roof Type:', getValue(rowData,'Roof Type:')]
				].forEach(([label, value]) => {
					if (value && String(value).trim()) {
						const chip = document.createElement('span'); chip.className = 'chip';
						chip.textContent = label.replace(/:?$/,'') + ': ' + value; chips.appendChild(chip);
					}
				});

				heroBox.innerHTML = ''; heroCaption.textContent = '';
				const raw = extractPhotoUrl(rowData['PhotoURL'], rowData['Photo:']);
				if (raw) {
					hero.hidden = false;
					if (isDriveLink(raw)) {
						const id = getDriveId(raw);
						const iframe = document.createElement('iframe');
						iframe.className = 'drive-frame'; iframe.loading = 'lazy'; iframe.referrerPolicy = 'no-referrer';
						iframe.src = 'https://drive.google.com/file/d/' + id + '/preview'; heroBox.appendChild(iframe);
					} else {
						const img = document.createElement('img'); img.alt = 'Photo'; img.loading = 'lazy'; img.src = raw;
						img.onerror = () => { heroCaption.textContent = 'Could not inline image. Open original in a new tab.'; };
						heroBox.appendChild(img);
					}
				} else { hero.hidden = true; }

				kv.innerHTML = '';
				MODAL_KEYS.forEach(k => {
					const v = getValue(rowData, k);
					if (v == null || String(v).trim() === '') return;
					const isPhotoField = /Photo:$/i.test(k);
					const dt = document.createElement('dt'); dt.textContent = k.replace(/:$/,'');
					const dd = document.createElement('dd');
					if (isPhotoField) {
						const rawUrl = extractPhotoUrl(rowData[k + 'URL'], v) || extractPhotoUrl('', v);
						if (rawUrl) {
							dd.className = 'photo-dd';
							const wrap = document.createElement('div'); wrap.className = 'photo-wrap';
							let inner;
							if (isDriveLink(rawUrl)) {
								const id = getDriveId(rawUrl);
								const thumb = id ? ('https://drive.google.com/thumbnail?id=' + encodeURIComponent(id) + '&sz=w640') : '';
								if (thumb) { inner = document.createElement('img'); inner.className='mini-photo'; inner.loading='lazy'; inner.alt=dt.textContent; inner.src=thumb; }
							} else {
								inner = document.createElement('img'); inner.className='mini-photo'; inner.loading='lazy'; inner.alt=dt.textContent; inner.src=rawUrl;
								inner.onerror = () => { dd.textContent = v; };
							}
							if (inner) {
								const link = document.createElement('a'); link.href = rawUrl; link.target='_blank'; link.rel='noopener'; link.appendChild(inner);
								wrap.appendChild(link); dd.appendChild(wrap);
								const cap = document.createElement('div'); cap.className='photo-caption'; cap.textContent='Open full image in new tab'; dd.appendChild(cap);
							} else { dd.textContent = v; }
						} else { dd.textContent = v; }
					} else {
						dd.textContent = v;
					}
					kv.appendChild(dt); kv.appendChild(dd);
				});

				// Open pinned near top and ensure the dialog itself is scrolled to top
				modal.showModal();
				modal.scrollTop = 0;
				const mb = modal.querySelector('.modal__body'); if (mb) mb.scrollTop = 0;
			}

			// Row click â†’ open modal
			$('#example tbody').on('click', 'tr', function () {
				const r = table.row(this);
				if (!r) return;
				const data = r.data();
				if (data) openModalForRow(data);
			});

			// Close modal
			const modalEl = document.getElementById('rowModal');
			modalEl.querySelector('.modal__close').addEventListener('click', () => modalEl.close());
			modalEl.addEventListener('click', (e) => {
				const rect = modalEl.getBoundingClientRect();
				const inside = e.clientX >= rect.left && e.clientX <= rect.right &&
				e.clientY >= rect.top  && e.clientY <= rect.bottom;
				if (!inside) modalEl.close();
			});
			document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modalEl.open) modalEl.close(); });
		</script>
	
<style id="popup-grid-css">
/* --- Modal grid layout cards (injected) ------------------------------- */
.grid-row {
  display: grid;
  gap: 16px;
  margin: 16px 0 0;
}
.grid-row.cols-1 { grid-template-columns: 1fr; }
.grid-row.cols-2 { grid-template-columns: 1fr 1fr; }
.grid-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

.card {
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  overflow: hidden;
}
.card__hdr {
  padding: 10px 12px;
  font-weight: 700;
  color: #111827;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
}
.card__body { padding: 10px 12px; }

.card dl {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 8px 12px;
  align-items: start;
}
.card dt {
  font-weight: 600;
  color: #374151;
}
.card dd {
  margin: 0;
  background: #fff;
  border: 1px solid #e5e7eb;
  padding: 8px 10px;
  border-radius: 8px;
  word-break: break-word;
}
.card dd.photo-dd { border: 0; padding: 0; background: transparent; }

/* ensure legacy kv stays hidden if present */
#kv { display: none !important; }

@media (max-width: 900px) {
  .grid-row.cols-3 { grid-template-columns: 1fr; }
  .grid-row.cols-2 { grid-template-columns: 1fr; }
  .card dl { grid-template-columns: 1fr; }
}
</style>


<script id="popup-grid-js">
// === Popup Grid Injection (safe override) ===============================
(function(){
  // Utilities expected to exist in page:
  // - getValue(row, key)   -> string
  // - isDriveLink(url)     -> boolean
  // - getDriveId(url)      -> string|null
  // - extractPhotoUrl(urlField, val) -> string|null
  // If any are missing, we no-op on photo handling.

  function safe(fn, fallback) { try { return fn(); } catch(e){ return fallback; } }
  function getValue(row, key){ return safe(()=>window.getValue(row,key), (row && (row[key]||row[key?.replace(/:$/,'')])) || ''); }
  function isDriveLink(u){ return safe(()=>window.isDriveLink(u), /drive\.google\.com|docs\.google\.com/.test(u||'')); }
  function getDriveId(u){ return safe(()=>window.getDriveId(u), (u||'').match(/[\?&]id=([^&]+)/)?.[1] || (u||'').match(/\/d\/([^\/]+)/)?.[1] || null); }
  function extractPhotoUrl(urlField, v){ return safe(()=>window.extractPhotoUrl(urlField, v), (urlField||'') || (v||'')); }

  const GRID_LAYOUT = [
    { columns: 1, groups: [ { title: null, fields: [
      'Business Name:','Address:','Knox Box Location:','Closest Hydrant:',
      'Contact Name (1):','Contact Number (1):','Contact Name (2):','Contact Number (2):'
    ] } ] },
    { columns: 2, groups: [
      { title: 'General Information', fields: [
        'Number of Stories:','Occupancy:','Occupancy Notes:','Construction Type:',
        'Construction Type Notes:','Roof Type:','Basement:','Roof Access Location:'
      ]},
      { title: 'Elevators', fields: [
        'Number of Elevators:','Elevator Type:','Elevator Notes:','Elevator Shutoff Location:'
      ]}
    ]},
    { columns: 3, groups: [
      { title: 'Alarm', fields: ['Alarm Type:','Alarm Location:','Remote Alarm Location:','Alarm Notes:'] },
      { title: 'Gas', fields: ['Gas Shutoff Location:','Gas Shutoff Photo:'] },
      { title: 'Electrical', fields: ['Electrical Shutoff Location:','Electrical Shutoff Photo:'] }
    ]},
    { columns: 3, groups: [
      { title: 'Water', fields: ['Water Shutoff Location:','Water Shutoff Photo:'] },
      { title: 'Sprinkler', fields: ['Sprinkler Main Shutoff Location:','Sprinkler Shutoff Photo:'] },
      { title: 'Fire Pump', fields: ['Fire Pump Location:'] }
    ]},
    { columns: 3, groups: [
      { title: 'Tanks', fields: ['Tanks:','Tanks Photo:'] },
      { title: 'Combustibles', fields: ['Combustibles:'] },
      { title: 'Gas', fields: ['Gas:'] }
    ]},
    { columns: 2, groups: [
      { title: 'Hazardous Materials', fields: ['Haz-Mat:'] },
      { title: 'Other', fields: ['Other Notes:'] }
    ]}
  ];

  function val(row, key){ return getValue(row, key) || ''; }
  function isPhotoKey(k){ return /Photo:$/i.test(k); }

  function makeDD(row, key, labelText){
    const v = val(row, key);
    if (!v) return null;
    const dd = document.createElement('dd');

    if (isPhotoKey(key)){
      const rawUrl = extractPhotoUrl((row && row[key + 'URL']) || '', v) || extractPhotoUrl('', v);
      if (rawUrl){
        dd.className = 'photo-dd';
        const wrap = document.createElement('div'); wrap.className = 'photo-wrap';
        let inner;
        if (isDriveLink(rawUrl)){
          const id = getDriveId(rawUrl);
          const thumb = id ? ('https://drive.google.com/thumbnail?id=' + encodeURIComponent(id) + '&sz=w640') : '';
          if (thumb){
            inner = document.createElement('img');
            inner.className = 'mini-photo';
            inner.loading = 'lazy';
            inner.alt = labelText;
            inner.src = thumb;
          }
        } else {
          inner = document.createElement('img');
          inner.className = 'mini-photo';
          inner.loading = 'lazy';
          inner.alt = labelText;
          inner.src = rawUrl;
          inner.onerror = () => { dd.textContent = v; };
        }
        if (inner){
          const link = document.createElement('a');
          link.href = rawUrl; link.target = '_blank'; link.rel = 'noopener';
          link.appendChild(inner);
          wrap.appendChild(link);
          dd.appendChild(wrap);
          const cap = document.createElement('div');
          cap.className = 'photo-caption';
          cap.textContent = 'Open full image in new tab';
          dd.appendChild(cap);
        } else {
          dd.textContent = v;
        }
      } else {
        dd.textContent = v;
      }
    } else {
      dd.textContent = v;
    }
    return dd;
  }

  function renderGrid(row){
    // Ensure a container exists right after legacy #kv (or inside modal body as fallback)
    let gridWrap = document.getElementById('gridWrap');
    const kv = document.getElementById('kv');
    if (!gridWrap){
      gridWrap = document.createElement('div');
      gridWrap.id = 'gridWrap';
      if (kv && kv.parentNode){
        kv.parentNode.insertBefore(gridWrap, kv.nextSibling);
      } else {
        (document.querySelector('.modal__body') || document.body).appendChild(gridWrap);
      }
    }
    gridWrap.innerHTML = '';

    GRID_LAYOUT.forEach((rowDef)=>{
      const rowEl = document.createElement('div');
      rowEl.className = 'grid-row cols-' + rowDef.columns;

      rowDef.groups.forEach((group)=>{
        const anyValue = (group.fields||[]).some((f)=> !!val(row,f));
        if (!anyValue) return;

        const card = document.createElement('section');
        card.className = 'card';

        if (group.title){
          const hdr = document.createElement('div');
          hdr.className = 'card__hdr';
          hdr.textContent = group.title;
          card.appendChild(hdr);
        }

        const body = document.createElement('div');
        body.className = 'card__body';
        const dl = document.createElement('dl');

        (group.fields||[]).forEach((fieldKey)=>{
          const value = val(row, fieldKey);
          if (!value) return;
          const dt = document.createElement('dt');
          dt.textContent = String(fieldKey).replace(/:$/,'');
          const dd = makeDD(row, fieldKey, dt.textContent);
          if (!dd) return;
          dl.appendChild(dt);
          dl.appendChild(dd);
        });

        body.appendChild(dl);
        card.appendChild(body);
        rowEl.appendChild(card);
      });

      if (rowEl.children.length) gridWrap.appendChild(rowEl);
    });
  }

  // Override openModalForRow safely to render our grids after the original logic
  const tryOverride = () => {
    const oldOpen = window.openModalForRow;
    if (typeof oldOpen !== 'function') return false;
    if (oldOpen.__hfdGridPatched) return true;

    window.openModalForRow = function(rowData){
      const result = oldOpen.apply(this, arguments);
      try {
        // hide legacy kv list if present
        const kv = document.getElementById('kv');
        if (kv) kv.style.display = 'none';
        // render our new layout
        renderGrid(rowData);
      } catch(e){ console.error('Grid render error:', e); }
      return result;
    };
    window.openModalForRow.__hfdGridPatched = true;
    return true;
  };

  // Attempt immediately and again after load to cover different script orders
  if (!tryOverride()){
    window.addEventListener('load', tryOverride, { once: true });
    document.addEventListener('DOMContentLoaded', tryOverride, { once: true });
  }
})();
</script>

<style id="popup-grid-stacked-css">
/* Stack data under descriptor inside modal cards */
.card dl { 
  display: grid;
  grid-template-columns: 1fr !important; 
  gap: 4px 0 !important;
}
.card dt {
  margin: 10px 0 4px;
  font-weight: 700;
  color: #111827;
}
.card dd {
  margin: 0 0 8px 0;
}
/* first dt gets a bit less top margin */
.card dl > dt:first-child { margin-top: 0; }
</style>

<style id="popup-photo-title-hide">
/* Hide only labels for photo fields, keep images visible */
.card dl > dt:has(+ dd.photo-dd) { 
  display: none !important; 
}
/* tighten spacing when label is hidden */
.card dl > dd.photo-dd { 
  margin-top: 0 !important; 
}
</style>

<script id="popup-label-postprocess">
(function(){
  // Map original labels -> new labels
  const REMAP = new Map([
    ['Fire Pump Location','Location'],
    ['Sprinkler Main Shutoff Location','Main Shutoff Location'],
    ['Water Shutoff Location','Shutoff Location'],
    ['Electrical Shutoff Location','Shutoff Location'],
    ['Gas Shutoff Location','Shutoff Location'],
    ['Alarm Type','Type'],
    ['Alarm Location','Location'],
    ['Alarm Notes','Notes'],
    ['Elevator Type','Type'],
    ['Elevator Notes','Notes'],
    ['Elevator Shutoff Location','Shutoff Location'],
    ['Construction Type Notes','Construction Notes'],
  ]);

  // Hide labels entirely for these fields (values remain)
  const HIDE = new Set(['Tanks','Combustibles','Gas','Other Notes','Haz-Mat']);

  function postProcessLabels(){
    const root = document.getElementById('gridWrap');
    if (!root) return;
    root.querySelectorAll('.card dl > dt').forEach((dt)=>{
      const original = dt.textContent.trim();
      // rename first
      const mapped = REMAP.get(original);
      if (mapped){ dt.textContent = mapped; }
      // hide for specified fields (match either original or mapped text)
      const current = dt.textContent.trim();
      if (HIDE.has(original) || HIDE.has(current)){
        dt.style.display = 'none';
        const dd = dt.nextElementSibling;
        if (dd && dd.tagName === 'DD'){ dd.style.marginTop = '0'; }
      }
    });
  }

  function wrapOpen(){
    const old = window.openModalForRow;
    if (typeof old !== 'function') return false;
    if (old.__labelPostProcessed) return true;
    window.openModalForRow = function(){
      const res = old.apply(this, arguments);
      try { postProcessLabels(); } catch(e){ console.warn('label post-process failed', e); }
      return res;
    };
    window.openModalForRow.__labelPostProcessed = true;
    return true;
  }

  if (!wrapOpen()){
    window.addEventListener('load', wrapOpen, {once:true});
    document.addEventListener('DOMContentLoaded', wrapOpen, {once:true});
  }
})();
</script>

<script id="popup-remove-bubbles-only">
(function(){
  function removeChipRows(){
    const body = document.querySelector('.modal__body');
    if (!body) return;

    // 1) Remove obvious chip containers by class name
    body.querySelectorAll('[class*="chip"], [class*="Chip"], [class*="pill"], [class*="badge"], .kv-chips, .kv-chips-row, .kv-pills')
      .forEach(el => el.remove());

    // 2) Heuristic: a direct child that looks like a chip-row (>=3 rounded items)
    Array.from(body.children).forEach(div => {
      const kids = Array.from(div.children);
      if (kids.length < 3) return;
      const rounded = kids.filter(n => {
        const cs = getComputedStyle(n);
        const radius = parseFloat((cs.borderTopLeftRadius||'0').replace('px','')) || 0;
        const bw = parseFloat((cs.borderWidth||'0').replace('px','')) || 0;
        // looks like a pill: rounded corners and visible border
        return radius >= 12 && bw >= 1;
      });
      if (rounded.length >= 3) {
        div.remove();
      }
    });
  }

  function wrapOpen(){
    const old = window.openModalForRow;
    if (typeof old !== 'function') return false;
    if (old.__removeBubblesOnly) return true;
    window.openModalForRow = function(){
      const res = old.apply(this, arguments);
      try { removeChipRows(); } catch(e){ console.warn('remove bubbles failed', e); }
      return res;
    };
    window.openModalForRow.__removeBubblesOnly = true;

    // If an earlier "trim above photo" hook exists, neutralize its effect by marking it as applied
    // so it won't try to rewrap again on dynamic reloads.
    if (window.openModalForRow.__trimAbovePhotoAppliedV2) {
      // nothing: we cannot undo removal if it already ran, but by choosing a base file
      // without v2 we avoid this in the first place.
    }
    return true;
  }

  if (!wrapOpen()){
    window.addEventListener('load', wrapOpen, {once:true});
    document.addEventListener('DOMContentLoaded', wrapOpen, {once:true});
  }
})();
</script>
</body>
</html>

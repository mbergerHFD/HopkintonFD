<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HFD Preplans Admin</title>
  <style>
    :root {
      --bg:#0b1220; --card:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#60a5fa; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    html,body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    header { position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(8px); background:rgba(11,18,32,.8); border-bottom:1px solid #1f2937; }
    header .wrap { max-width:1100px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; gap:14px; }
    header h1 { font-size:18px; margin:0; letter-spacing:.4px; }
    main { max-width:1100px; margin:0 auto; padding:18px 16px 40px; }

    .card { background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; }
    .grid { display:grid; gap:12px; }

    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:700px){ .row{ grid-template-columns:1fr; } }

    label { display:grid; gap:6px; font-size:14px; color:#cbd5e1; }
    input, select, textarea { background:#0f172a; color:var(--text); border:1px solid #243045; border-radius:10px; padding:10px 12px; font:inherit; }
    textarea { min-height:80px; }
    button { background:#0f172a; color:var(--text); border:1px solid #243045; border-radius:10px; padding:10px 12px; cursor:pointer; }
    button.primary { background:var(--accent); color:#08101d; border-color:transparent; }
    button.ghost { background:transparent; border-color:#334155; }
    button.warn { background:var(--warn); color:#0b0b0b; border-color:transparent; }
    button.bad { background:var(--bad); color:#0b0b0b; border-color:transparent; }

    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .toolbar .grow { flex:1 1 auto; min-width:200px; }

    table { width:100%; border-collapse:collapse; font-size:14px; }
    thead th { text-align:left; font-weight:600; color:#cbd5e1; border-bottom:1px solid #1f2937; padding:10px 8px; white-space:nowrap; }
    tbody td { border-bottom:1px solid #1f2937; padding:10px 8px; vertical-align:top; }
    tbody tr:hover { background:#0f172a; }
    .badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #334155; }
    .badge.approved { background:rgba(16,185,129,.12); border-color:rgba(16,185,129,.35); color:#86efac; }
    .badge.in_review { background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:#fde68a; }
    .badge.draft { background:rgba(59,130,246,.12); border-color:rgba(59,130,246,.35); color:#93c5fd; }

    .muted { color:var(--muted); }
    .pill { padding:6px 10px; border-radius:999px; border:1px solid #2b3a55; background:#0f172a; }

    .flex { display:flex; gap:10px; align-items:center; }
    .right { margin-left:auto; }

    dialog.modal { width:min(900px, 92vw); border:none; border-radius:16px; padding:0; background:#0b1220; color:var(--text); }
    .modal__header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #1f2937; position:sticky; top:0; background:#0b1220; }
    .modal__body { padding:16px; max-height:min(70vh, 70svh); overflow:auto; }
    .modal__footer { padding:12px 16px; border-top:1px solid #1f2937; display:flex; gap:8px; justify-content:flex-end; }

    .hint { font-size:13px; color:#9aa5b1; }
    .spacer { height:12px; }
      .tabs { display:flex; gap:6px; border-bottom:1px solid #1f2937; margin-bottom:12px; }
    .tabs button { padding:8px 10px; border:1px solid #2b3a55; background:#0f172a; color:var(--text); border-bottom:none; border-radius:10px 10px 0 0; cursor:pointer; }
    .tabs button.active { background:#111827; }
    .tabpanel { display:none; }
    .tabpanel.active { display:block; }
    .mini-table { width:100%; border-collapse:collapse; font-size:14px; }
    .mini-table th, .mini-table td { border-bottom:1px solid #1f2937; padding:8px 6px; text-align:left; vertical-align:top; }
    .uploader { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>HFD Preplans Admin</h1>
      <div class="right flex" id="userBar" hidden>
        <span id="whoami" class="muted"></span>
        <button id="logoutBtn" class="ghost">Sign out</button>
      </div>
    </div>
  </header>

  <main>
    <!-- AUTH -->
    <section id="authCard" class="card grid">
      <h2>Sign in</h2>
      <form id="signInForm" class="grid">
        <div class="row">
          <label>Email <input type="email" name="email" required /></label>
          <label>Password <input type="password" name="password" required /></label>
        </div>
        <div class="flex">
          <button class="primary">Sign in</button>
          <span id="authMsg" class="hint"></span>
        </div>
      </form>
      <p class="hint">Create users in Supabase → Auth → Users. This page uses your Supabase Auth and Row Level Security.</p>
    </section>

    <!-- SEARCH & REVIEW -->
    <section id="reviewCard" class="card grid" hidden>
      <div class="toolbar">
        <input id="q" class="grow" placeholder="Search name or address…" />
        <select id="status">
          <option value="">All statuses</option>
          <option value="approved">Approved</option>
          <option value="in_review">In review</option>
          <option value="draft">Draft</option>
        </select>
        <input id="city" placeholder="City (optional)" />
        <select id="sort">
          <option value="name">Sort: Name</option>
          <option value="city">Sort: City</option>
          <option value="last_reviewed">Sort: Last reviewed</option>
          <option value="risk_score">Sort: Risk score</option>
          <option value="id">Sort: ID</option>
        </select>
        <select id="dir">
          <option value="asc">Asc</option>
          <option value="desc">Desc</option>
        </select>
        <button id="searchBtn" class="primary">Search</button>
      </div>

      <div class="spacer"></div>

      <div class="flex">
        <div class="muted" id="count"></div>
        <div class="right flex">
          <button id="prevPage" class="ghost" disabled>Prev</button>
          <button id="nextPage" class="ghost" disabled>Next</button>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="tableWrap">
        <table id="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>City</th>
              <th>Status</th>
              <th>Risk</th>
              <th>Last Reviewed</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- QUICK ADD SITE (optional) -->
    <section id="quickAdd" class="card grid" hidden>
      <h2>Quick add site</h2>
      <form id="siteForm" class="grid">
        <div class="row">
          <label>Site name <input name="name" required /></label>
          <label>Status
            <select name="status">
              <option>draft</option>
              <option>in_review</option>
              <option>approved</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label>Address 1 <input name="address_line1" required /></label>
          <label>City <input name="city" required /></label>
        </div>
        <div class="row">
          <label>Latitude <input name="latitude" type="number" step="any" /></label>
          <label>Longitude <input name="longitude" type="number" step="any" /></label>
        </div>
        <div class="row">
          <label>Occupancy <input name="occupancy_type" /></label>
          <label>Construction <input name="construction_type" /></label>
        </div>
        <label>Special Instructions <textarea name="special_instructions"></textarea></label>
        <div class="flex">
          <button class="primary">Save Site</button>
          <span id="siteMsg" class="hint"></span>
        </div>
      </form>
    </section>
  </main>

  <!-- DETAILS / EDIT MODAL -->
  <dialog id="details" class="modal">
    <div class="modal__header">
      <strong id="detailsTitle">Site</strong>
      <button id="closeDetails" class="ghost">Close</button>
    </div>
    <div class="modal__body">
      <div id="detailsBody" class="grid"></div>
    </div>
    <div class="modal__footer">
      <button id="saveEdit" class="primary">Save changes</button>
      <button id="deleteSite" class="bad">Delete</button>
    </div>
  </dialog>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Supabase project credentials (provided by you)
    const SUPABASE_URL = "https://loppyxebzoyrcgqwdxee.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvcHB5eGViem95cmNncXdkeGVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NjAwNDMsImV4cCI6MjA3NTUzNjA0M30.syk6wL25hBg5enkaI6oTbfAcoKNuvXdyRO8IHQT9X5c";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === UI refs ===
    const authCard = document.getElementById('authCard');
    const reviewCard = document.getElementById('reviewCard');
    const quickAdd = document.getElementById('quickAdd');
    const userBar = document.getElementById('userBar');
    const whoami = document.getElementById('whoami');

    const q = document.getElementById('q');
    const statusSel = document.getElementById('status');
    const city = document.getElementById('city');
    const sortSel = document.getElementById('sort');
    const dirSel = document.getElementById('dir');
    const countEl = document.getElementById('count');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const tbody = document.querySelector('#table tbody');

    const PAGE_SIZE = 25;
    let page = 0; // zero-based

    // Escape wildcard characters for ILIKE patterns
    function escapeLike(val){
      return String(val).replace(/[%_]/g, (m) => `\${m}`);
    }

    // === Auth state ===
    const { data: { session } } = await supabase.auth.getSession();
    if (session) onAuthed(session.user); else onSignedOut();

    supabase.auth.onAuthStateChange((_evt, session) => {
      if (session?.user) onAuthed(session.user); else onSignedOut();
    });

    function onAuthed(user){
      authCard.hidden = true;
      reviewCard.hidden = false;
      quickAdd.hidden = false;
      userBar.hidden = true; // hide email on shared screens
      whoami.textContent = user.email || user.id;
      loadPage(0);
    }
    function onSignedOut(){
      authCard.hidden = false;
      reviewCard.hidden = true;
      quickAdd.hidden = true;
      userBar.hidden = true;
    }

    // === Sign in ===
    document.getElementById('signInForm').onsubmit = async (e)=>{
      e.preventDefault();
      const f = new FormData(e.target);
      const { error } = await supabase.auth.signInWithPassword({
        email: f.get('email'), password: f.get('password')
      });
      document.getElementById('authMsg').textContent = error ? error.message : 'Signed in.';
    };

    document.getElementById('logoutBtn')?.addEventListener('click', async ()=>{
      await supabase.auth.signOut();
    });

    // === Search controls ===
    document.getElementById('searchBtn').onclick = ()=> loadPage(0);
    q.addEventListener('keydown', (e)=>{ if (e.key==='Enter') loadPage(0); });
    statusSel.onchange = ()=> loadPage(0);
    city.addEventListener('keydown', (e)=>{ if (e.key==='Enter') loadPage(0); });
    sortSel.onchange = ()=> loadPage(page);
    dirSel.onchange = ()=> loadPage(page);

    prevBtn.onclick = ()=> loadPage(Math.max(0,page-1));
    nextBtn.onclick = ()=> loadPage(page+1);

    async function loadPage(p){
      page = p;
      const from = p*PAGE_SIZE;
      const to = from + PAGE_SIZE - 1;

      let query = supabase.from('sites')
        .select('id,name,city,status,risk_score,last_reviewed,address_line1', { count: 'exact' })

      // Filters
      const text = q.value.trim();
      if (text) {
        const pat = `%${escapeLike(text)}%`;
        // name OR address_line1 OR city
        query = query.or(`name.ilike.${pat},address_line1.ilike.${pat},city.ilike.${pat}`);
      }
      const st = statusSel.value.trim();
      if (st) query = query.eq('status', st);
      const c = city.value.trim();
      if (c) query = query.ilike('city', `%${escapeLike(c)}%`);

      // Sorting
      const sortCol = sortSel.value;
      const ascending = dirSel.value === 'asc';
      query = query.order(sortCol, { ascending });

      // Range / pagination
      query = query.range(from, to);

      const { data, error, count } = await query;
      if (error){ console.error(error); tbody.innerHTML = `<tr><td colspan="7">Error: ${error.message}</td></tr>`; return; }

      renderRows(data || []);
      countEl.textContent = `${count ?? 0} result${(count??0)===1?'':'s'} • Page ${page+1}`;
      prevBtn.disabled = page === 0;
      nextBtn.disabled = (data?.length ?? 0) < PAGE_SIZE || ((from + (data?.length||0)) >= (count ?? 0));
    }

    function renderRows(rows){
      tbody.innerHTML = '';
      if (!rows.length){
        tbody.innerHTML = '<tr><td colspan="7" class="muted">No results</td></tr>';
        return;
      }
      for (const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${escapeHtml(r.name || '')}</td>
          <td>${escapeHtml(r.city || '')}</td>
          <td>${statusBadge(r.status)}</td>
          <td>${r.risk_score ?? ''}</td>
          <td>${r.last_reviewed ? new Date(r.last_reviewed).toLocaleDateString() : '<span class="muted">—</span>'}</td>
          <td class="flex">
            <button class="ghost" data-view="${r.id}">View</button>
            <button class="ghost" data-edit="${r.id}">Edit</button>
          </td>`;
        tbody.appendChild(tr);
      }
      // actions
      tbody.querySelectorAll('[data-view]').forEach(btn=> btn.addEventListener('click', ()=> openDetails(btn.dataset.view, false)));
      tbody.querySelectorAll('[data-edit]').forEach(btn=> btn.addEventListener('click', ()=> openDetails(btn.dataset.edit, true)));
    }

    function statusBadge(s){
      const cls = s==='approved'?'approved':(s==='in_review'?'in_review':'draft');
      return `<span class="badge ${cls}">${s||'draft'}</span>`;
    }

    // === Quick add site ===
    document.getElementById('siteForm').onsubmit = async (e)=>{
      e.preventDefault();
      const f = Object.fromEntries(new FormData(e.target).entries());
      if (f.latitude === "") f.latitude = null; else f.latitude = Number(f.latitude);
      if (f.longitude === "") f.longitude = null; else f.longitude = Number(f.longitude);
      const { data, error } = await supabase.from('sites').insert([f]).select('id').single();
      const msg = document.getElementById('siteMsg');
      if (error){ msg.textContent = error.message; return; }
      msg.textContent = `Saved site id ${data.id}`;
      e.target.reset();
      loadPage(0);
    };

    // === Details modal (view/edit) ===
    const dlg = document.getElementById('details');
    const detailsTitle = document.getElementById('detailsTitle');
    const detailsBody = document.getElementById('detailsBody');
    const closeDetails = document.getElementById('closeDetails');
    const saveEdit = document.getElementById('saveEdit');
    const deleteSiteBtn = document.getElementById('deleteSite');

    let currentSiteId = null;

    closeDetails.onclick = ()=> dlg.close();

    async function openDetails(id, editable){
      currentSiteId = Number(id);
      const { data: site, error } = await supabase.from('sites').select('*').eq('id', currentSiteId).single();
      if (error){ alert(error.message); return; }
      detailsTitle.textContent = `Site #${site.id} — ${site.name}`;

      // Load related sets
      const [haz, water, docs, systemsData, utilitiesData, contactsData, siteContactsData, reviewsData, defData] = await Promise.all([
        supabase.from('hazards').select('*').eq('site_id', currentSiteId),
        supabase.from('water_supplies').select('*').eq('site_id', currentSiteId),
        supabase.from('documents').select('*').eq('site_id', currentSiteId).order('uploaded_at', { ascending:false }),
        supabase.from('systems').select('*').eq('site_id', currentSiteId),
        supabase.from('utilities').select('*').eq('site_id', currentSiteId),
        supabase.from('contacts').select('*'),
        supabase.from('site_contacts').select('*').eq('site_id', currentSiteId),
        supabase.from('reviews').select('*').eq('site_id', currentSiteId).order('reviewed_at', { ascending:false }),
        supabase.from('deficiencies').select('*').eq('site_id', currentSiteId).order('created_at', { ascending:false })
      ]);

      const hazards = haz.data||[];
      const waters = water.data||[];
      const documents = docs.data||[];
      const systems = systemsData.data||[];
      const utilities = utilitiesData.data||[];
      const contacts = contactsData.data||[];
      const siteContacts = siteContactsData.data||[];
      const reviews = reviewsData.data||[];
      const deficiencies = defData.data||[];

      const tabs = [
        {id:'tab-overview', label:'Overview'},
        {id:'tab-hazards', label:'Hazards'},
        {id:'tab-water', label:'Water'},
        {id:'tab-systems', label:'Systems'},
        {id:'tab-utilities', label:'Utilities'},
        {id:'tab-contacts', label:'Contacts'},
        {id:'tab-docs', label:'Documents'},
        {id:'tab-reviews', label:'Reviews'},
        {id:'tab-defs', label:'Deficiencies'}
      ];

      detailsBody.innerHTML = `
        <div class="tabs">${tabs.map((t,i)=>`<button data-tab="${t.id}" class="${i===0?'active':''}">${t.label}</button>`).join('')}</div>
        ${tabs.map((t,i)=>`<div id="${t.id}" class="tabpanel ${i===0?'active':''}"></div>`).join('')}
      `;

      // Populate each tab
      renderOverview(site, hazards, waters, documents, systems, utilities, reviews);
      renderHazards(hazards, editable);
      renderWater(waters, editable);
      renderSystems(systems, editable);
      renderUtilities(utilities, editable);
      renderContacts(contacts, siteContacts, editable);
      renderDocuments(documents, editable);
      renderReviews(reviews, editable);
      renderDefs(deficiencies, editable);

      // tab switching
      detailsBody.querySelectorAll('.tabs button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-tab');
          detailsBody.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          detailsBody.querySelectorAll('.tabpanel').forEach(p=>p.classList.remove('active'));
          document.getElementById(id).classList.add('active');
        });
      });

      saveEdit.style.display = editable ? 'inline-block' : 'none';
      deleteSiteBtn.style.display = 'inline-block';
      dlg.showModal();
    }

    function renderOverview(site, hazards, water, docs, systems, utilities, reviews){
      const el = document.getElementById('tab-overview');
      el.innerHTML = `
        <div class="grid">
          <div class="row">
            <div class="card">
              <h3>Overview</h3>
              <p><strong>Name:</strong> ${escapeHtml(site.name)}</p>
              <p><strong>Address:</strong> ${escapeHtml(site.address_line1||'')}, ${escapeHtml(site.city||'')} ${escapeHtml(site.state||'')}</p>
              <p><strong>Status:</strong> ${statusBadge(site.status)}</p>
              <p><strong>Occupancy:</strong> ${escapeHtml(site.occupancy_type||'')}</p>
              <p><strong>Construction:</strong> ${escapeHtml(site.construction_type||'')}</p>
              <p><strong>Stories / Sq Ft:</strong> ${site.stories??'—'} / ${site.square_feet??'—'}</p>
              <p><strong>Systems:</strong> Sprinklered: ${site.sprinklered? 'Yes':'No'} • Standpipe: ${site.standpipe? 'Yes':'No'} • Alarm: ${site.alarm_present? 'Yes':'No'}</p>
              <p><strong>FDC:</strong> ${escapeHtml(site.fdc_type||'—')} @ ${escapeHtml(site.fdc_location||'')}</p>
              <p><strong>Knox Box:</strong> ${escapeHtml(site.knox_box_location||'')}</p>
              <p><strong>Shutoffs:</strong> Gas: ${escapeHtml(site.gas_shutoff_location||'')}; Electric: ${escapeHtml(site.electric_shutoff_location||'')}; Water: ${escapeHtml(site.water_shutoff_location||'')}</p>
              <p><strong>Roof access:</strong> ${escapeHtml(site.roof_access||'')}</p>
              <p><strong>Risk:</strong> ${site.risk_score ?? '—'} • <strong>Last reviewed:</strong> ${site.last_reviewed ? new Date(site.last_reviewed).toLocaleDateString() : '—'}</p>
              <p><strong>Notes:</strong> ${escapeHtml(site.special_instructions||'')}</p>
            </div>
            <div class="card">
              <h3>Counts</h3>
              <p>Hazards: ${hazards.length}</p>
              <p>Water: ${water.length}</p>
              <p>Systems: ${systems.length}</p>
              <p>Utilities: ${utilities.length}</p>
              <p>Docs: ${docs.length}</p>
              <p>Reviews: ${reviews.length}</p>
            </div>
          </div>
        </div>`;
    }

    function renderHazards(rows, editable){
      const el = document.getElementById('tab-hazards');
      let html = `<table class="mini-table"><thead><tr><th>Type</th><th>Description</th><th>Floor</th><th>Room</th><th>Notes</th><th></th></tr></thead><tbody>`;
      if (!rows.length) html += `<tr><td colspan="6" class="muted">No hazards</td></tr>`;
      for (const h of rows){
        html += `<tr><td>${escapeHtml(h.hazard_type)}</td><td>${escapeHtml(h.description||'')}</td><td>${escapeHtml(h.floor||'')}</td><td>${escapeHtml(h.room||'')}</td><td>${escapeHtml(h.location_notes||'')}</td><td><button class="ghost" data-del-hz="${h.id}">Delete</button></td></tr>`;
      }
      html += `</tbody></table>`;
      if (editable){
        html += `
          <h4>Add hazard</h4>
          <form id="hzForm" class="row">
            <label>Type <input name="hazard_type" required></label>
            <label>Description <input name="description"></label>
            <label>Floor <input name="floor"></label>
            <label>Room <input name="room"></label>
            <label>Location notes <input name="location_notes"></label>
            <button class="primary">Add</button>
          </form>`;
      }
      el.innerHTML = html;

      el.querySelectorAll('[data-del-hz]').forEach(btn=> btn.onclick = async ()=>{
        await supabase.from('hazards').delete().eq('id', Number(btn.dataset.delHz));
        openDetails(currentSiteId, true);
      });
      el.querySelector('#hzForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target).entries());
        f.site_id = currentSiteId; await supabase.from('hazards').insert([f]);
        openDetails(currentSiteId, true);
      });
    }

    function renderWater(rows, editable){
      const el = document.getElementById('tab-water');
      let html = `<table class="mini-table"><thead><tr><th>Type</th><th>Lat</th><th>Lon</th><th>Dist (ft)</th><th>Flow (gpm)</th><th>Thread</th><th>Notes</th><th>OOS</th><th></th></tr></thead><tbody>`;
      if (!rows.length) html += `<tr><td colspan="9" class="muted">No water supplies</td></tr>`;
      for (const w of rows){
        html += `<tr><td>${escapeHtml(w.source_type)}</td><td>${w.latitude??''}</td><td>${w.longitude??''}</td><td>${w.distance_ft??''}</td><td>${w.flow_gpm??''}</td><td>${escapeHtml(w.thread_type||'')}</td><td>${escapeHtml(w.notes||'')}</td><td>${w.out_of_service?'Yes':'No'}</td><td><button class="ghost" data-del-wat="${w.id}">Delete</button></td></tr>`;
      }
      html += `</tbody></table>`;
      if (editable){
        html += `
          <h4>Add water point</h4>
          <form id="watForm" class="row">
            <label>Type <input name="source_type" placeholder="hydrant|cistern|static" required></label>
            <label>Lat <input name="latitude" type="number" step="any"></label>
            <label>Lon <input name="longitude" type="number" step="any"></label>
            <label>Distance (ft) <input name="distance_ft" type="number"></label>
            <label>Flow (gpm) <input name="flow_gpm" type="number"></label>
            <label>Thread <input name="thread_type"></label>
            <label>Notes <input name="notes"></label>
            <label>OOS <select name="out_of_service"><option value="false">No</option><option value="true">Yes</option></select></label>
            <button class="primary">Add</button>
          </form>`;
      }
      el.innerHTML = html;
      el.querySelectorAll('[data-del-wat]').forEach(btn=> btn.onclick = async ()=>{
        await supabase.from('water_supplies').delete().eq('id', Number(btn.dataset.delWat));
        openDetails(currentSiteId, true);
      });
      el.querySelector('#watForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target).entries());
        for (const k of ['latitude','longitude','distance_ft','flow_gpm']){ if (f[k]==='') f[k]=null; else f[k]=Number(f[k]); }
        f.out_of_service = String(f.out_of_service) === 'true';
        f.site_id = currentSiteId; await supabase.from('water_supplies').insert([f]);
        openDetails(currentSiteId, true);
      });
    }

    function renderSystems(rows, editable){
      const el = document.getElementById('tab-systems');
      let html = `<table class="mini-table"><thead><tr><th>Type</th><th>Coverage</th><th>Condition</th><th>Control Valve</th><th>Riser</th><th>Last Test</th><th></th></tr></thead><tbody>`;
      if (!rows.length) html += `<tr><td colspan="7" class="muted">No systems</td></tr>`;
      for (const s of rows){
        html += `<tr><td>${escapeHtml(s.system_type)}</td><td>${escapeHtml(s.coverage_area||'')}</td><td>${escapeHtml(s.condition||'')}</td><td>${escapeHtml(s.control_valve_location||'')}</td><td>${escapeHtml(s.riser_location||'')}</td><td>${s.last_test_date??''}</td><td><button class="ghost" data-del-sys="${s.id}">Delete</button></td></tr>`;
      }
      html += `</tbody></table>`;
      if (editable){
        html += `
          <h4>Add system</h4>
          <form id="sysForm" class="row">
            <label>Type <input name="system_type" required></label>
            <label>Coverage <input name="coverage_area"></label>
            <label>Condition <input name="condition" placeholder="good|impaired|red-tag"></label>
            <label>Control valve loc <input name="control_valve_location"></label>
            <label>Riser loc <input name="riser_location"></label>
            <label>Last test <input name="last_test_date" type="date"></label>
            <button class="primary">Add</button>
          </form>`;
      }
      el.innerHTML = html;
      el.querySelectorAll('[data-del-sys]').forEach(btn=> btn.onclick = async ()=>{
        await supabase.from('systems').delete().eq('id', Number(btn.dataset.delSys));
        openDetails(currentSiteId, true);
      });
      el.querySelector('#sysForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target).entries());
        f.site_id = currentSiteId; await supabase.from('systems').insert([f]);
        openDetails(currentSiteId, true);
      });
    }

    function renderUtilities(rows, editable){
      const el = document.getElementById('tab-utilities');
      let html = `<table class="mini-table"><thead><tr><th>Type</th><th>Location</th><th>Shutoff</th><th></th></tr></thead><tbody>`;
      if (!rows.length) html += `<tr><td colspan="4" class="muted">No utilities</td></tr>`;
      for (const u of rows){
        html += `<tr><td>${escapeHtml(u.utility_type)}</td><td>${escapeHtml(u.location_desc||'')}</td><td>${escapeHtml(u.shutoff_instructions||'')}</td><td><button class="ghost" data-del-util="${u.id}">Delete</button></td></tr>`;
      }
      html += `</tbody></table>`;
      if (editable){
        html += `
          <h4>Add utility</h4>
          <form id="utilForm" class="row">
            <label>Type <input name="utility_type" required></label>
            <label>Location <input name="location_desc"></label>
            <label>Shutoff instructions <input name="shutoff_instructions"></label>
            <button class="primary">Add</button>
          </form>`;
      }
      el.innerHTML = html;
      el.querySelectorAll('[data-del-util]').forEach(btn=> btn.onclick = async ()=>{
        await supabase.from('utilities').delete().eq('id', Number(btn.dataset.delUtil));
        openDetails(currentSiteId, true);
      });
      el.querySelector('#utilForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target).entries());
        f.site_id = currentSiteId; await supabase.from('utilities').insert([f]);
        openDetails(currentSiteId, true);
      });
    }

    function renderContacts(allContacts, links, editable){
      const el = document.getElementById('tab-contacts');
      const linkedIds = new Set(links.map(l=>l.contact_id));
      let html = `<h4>Linked contacts</h4><table class="mini-table"><thead><tr><th>Name</th><th>Role</th><th>Phone</th><th>Email</th><th>24/7</th><th>Primary</th><th></th></tr></thead><tbody>`;
      if (!links.length) html += `<tr><td colspan="7" class="muted">No linked contacts</td></tr>`;
      for (const l of links){
        const c = allContacts.find(x=>x.id===l.contact_id) || {name:'(missing)'};
        html += `<tr><td>${escapeHtml(c.name||'')}</td><td>${escapeHtml(c.role||'')}</td><td>${escapeHtml(c.phone_primary||'')}</td><td>${escapeHtml(c.email||'')}</td><td>${c.is_247?'Yes':'No'}</td><td>${l.is_primary?'Yes':'No'}</td><td><button class="ghost" data-unlink="${c.id}">Unlink</button></td></tr>`;
      }
      html += `</tbody></table>`;

      if (editable){
        // Add new contact + link
        html += `
          <div class="row card">
            <div>
              <h4>Create contact</h4>
              <form id="cNew" class="grid">
                <div class="row">
                  <label>Name <input name="name" required></label>
                  <label>Role <input name="role"></label>
                </div>
                <div class="row">
                  <label>Phone <input name="phone_primary"></label>
                  <label>Email <input name="email" type="email"></label>
                </div>
                <label>24/7 <select name="is_247"><option value="false">No</option><option value="true">Yes</option></select></label>
                <button class="primary">Create & Link</button>
              </form>
            </div>
            <div>
              <h4>Link existing contact</h4>
              <form id="cLink" class="grid">
                <label>Contact
                  <select name="contact_id">${allContacts.map(c=>`<option value="${c.id}">${escapeHtml(c.name||'')}${c.role?` — ${escapeHtml(c.role)}`:''}</option>`).join('')}</select>
                </label>
                <label>Primary <select name="is_primary"><option value="false">No</option><option value="true">Yes</option></select></label>
                <button class="primary">Link</button>
              </form>
            </div>
          </div>`;
      }

      el.innerHTML = html;

      el.querySelectorAll('[data-unlink]').forEach(btn=> btn.onclick = async ()=>{
        await supabase.from('site_contacts').delete().match({ site_id: currentSiteId, contact_id: Number(btn.dataset.unlink) });
        openDetails(currentSiteId, true);
      });

      el.querySelector('#cNew')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target).entries());
        f.is_247 = String(f.is_247)==='true';
        const { data, error } = await supabase.from('contacts').insert([f]).select('id').single();
        if (error){ alert(error.message); return; }
        await supabase.from('site_contacts').insert([{ site_id: currentSiteId, contact_id: data.id, is_primary:false }]);
        openDetails(currentSiteId, true);
      });

      el.querySelector('#cLink')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target).entries());
        await supabase.from('site_contacts').insert([{ site_id: currentSiteId, contact_id: Number(f.contact_id), is_primary: String(f.is_primary)==='true' }]);
        openDetails(currentSiteId, true);
      });
    }

    async function filePublicUrl(path){
      const { data } = supabase.storage.from('preplans').getPublicUrl(path);
      return data.publicUrl;
    }

    function renderDocuments(rows, editable){
      const el = document.getElementById('tab-docs');
      let html = `<div class="grid">`;
      if (editable){
        html += `
          <div class="card">
            <h4>Upload file</h4>
            <form id="docUp" class="uploader">
              <label>Type
                <select name="doc_type">
                  <option>photo</option>
                  <option>floorplan</option>
                  <option>exterior</option>
                  <option>interior</option>
                  <option>evac_map</option>
                </select>
              </label>
              <label>Caption <input name="caption" placeholder="Optional"></label>
              <input id="docFile" type="file" accept="image/*,application/pdf" required>
              <button class="primary">Upload</button>
              <span class="hint" id="docMsg"></span>
            </form>
          </div>`;
      }

      html += `<div class="card">
        <h4>Documents</h4>
        <table class="mini-table"><thead><tr><th>Type</th><th>File</th><th>Caption</th><th>Uploaded</th><th></th></tr></thead><tbody>`;
      if (!rows.length) html += `<tr><td colspan="5" class="muted">No documents</td></tr>`;
      for (const d of rows){
        html += `<tr>
          <td>${escapeHtml(d.doc_type)}</td>
          <td>${escapeHtml(d.file_path)}</td>
          <td>${escapeHtml(d.caption||'')}</td>
          <td>${d.uploaded_at? new Date(d.uploaded_at).toLocaleString():''}</td>
          <td><button class="ghost" data-del-doc="${d.id}">Delete</button></td>
        </tr>`
      }
      html += `</tbody></table></div></div>`;

      el.innerHTML = html;

      el.querySelector('#docUp')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const f = new FormData(e.target);
        const file = document.getElementById('docFile').files[0];
        if (!file){ document.getElementById('docMsg').textContent = 'Choose a file'; return; }
        const path = `preplans/${currentSiteId}/${Date.now()}_${file.name}`;
        const { error: upErr } = await supabase.storage.from('preplans').upload(path, file, { upsert:false });
        if (upErr){ document.getElementById('docMsg').textContent = upErr.message; return; }
        const doc = { site_id: currentSiteId, doc_type: f.get('doc_type'), caption: f.get('caption'), file_path: path };
        const { error: docErr } = await supabase.from('documents').insert([doc]);
        if (docErr){ document.getElementById('docMsg').textContent = docErr.message; return; }
        openDetails(currentSiteId, true);
      });

      el.querySelectorAll('[data-del-doc]').forEach(btn=> btn.onclick = async ()=>{
        await supabase.from('documents').delete().eq('id', Number(btn.dataset.delDoc));
        openDetails(currentSiteId, true);
      });
    }

    function renderReviews(rows, editable){
      const el = document.getElementById('tab-reviews');
      let html = `<table class="mini-table"><thead><tr><th>Reviewed at</th><th>Reviewed by</th><th>Findings</th><th>Next due</th><th></th></tr></thead><tbody>`;
      if (!rows.length) html += `<tr><td colspan="5" class="muted">No reviews</td></tr>`;
      for (const r of rows){
        html += `<tr><td>${new Date(r.reviewed_at).toLocaleString()}</td><td>${escapeHtml(r.reviewed_by||'')}</td><td>${escapeHtml(r.findings||'')}</td><td>${r.next_due_at??''}</td><td><button class="ghost" data-del-rev="${r.id}">Delete</button></td></tr>`;
      }
      html += `</tbody></table>`;
      if (editable){
        html += `
          <h4>Add review</h4>
          <form id="revForm" class="row">
            <label>Findings <input name="findings"></label>
            <label>Next due <input type="date" name="next_due_at"></label>
            <button class="primary">Add</button>
          </form>`;
      }
      el.innerHTML = html;
      el.querySelectorAll('[data-del-rev]').forEach(btn=> btn.onclick = async ()=>{
        await supabase.from('reviews').delete().eq('id', Number(btn.dataset.delRev));
        openDetails(currentSiteId, true);
      });
      el.querySelector('#revForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target).entries());
        f.site_id = currentSiteId; await supabase.from('reviews').insert([f]);
        openDetails(currentSiteId, true);
      });
    }

    function renderDefs(rows, editable){
      const el = document.getElementById('tab-defs');
      let html = `<table class="mini-table"><thead><tr><th>Title</th><th>Detail</th><th>Status</th><th>Created</th><th>Closed</th><th></th></tr></thead><tbody>`;
      if (!rows.length) html += `<tr><td colspan="6" class="muted">No deficiencies</td></tr>`;
      for (const d of rows){
        html += `<tr><td>${escapeHtml(d.title)}</td><td>${escapeHtml(d.detail||'')}</td><td>${escapeHtml(d.status||'open')}</td><td>${new Date(d.created_at).toLocaleString()}</td><td>${d.closed_at? new Date(d.closed_at).toLocaleString():'—'}</td><td><button class="ghost" data-del-def="${d.id}">Delete</button></td></tr>`;
      }
      html += `</tbody></table>`;
      if (editable){
        html += `
          <h4>Add deficiency</h4>
          <form id="defForm" class="row">
            <label>Title <input name="title" required></label>
            <label>Detail <input name="detail"></label>
            <label>Status <select name="status"><option>open</option><option>in_progress</option><option>resolved</option><option>closed</option></select></label>
            <button class="primary">Add</button>
          </form>`;
      }
      el.innerHTML = html;
      el.querySelectorAll('[data-del-def]').forEach(btn=> btn.onclick = async ()=>{
        await supabase.from('deficiencies').delete().eq('id', Number(btn.dataset.delDef));
        openDetails(currentSiteId, true);
      });
      el.querySelector('#defForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault(); const f = Object.fromEntries(new FormData(e.target).entries());
        f.site_id = currentSiteId; await supabase.from('deficiencies').insert([f]);
        openDetails(currentSiteId, true);
      });
    }

    // keep editForm (site core fields)
    function editForm(site){
      return `
        <form id="editForm" class="grid">
          <div class="row">
            <label>Name <input name="name" value="${escapeVal(site.name)}" required /></label>
            <label>Status
              <select name="status">
                ${['draft','in_review','approved'].map(s=>`<option ${site.status===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </label>
          </div>
          <div class="row">
            <label>Address 1 <input name="address_line1" value="${escapeVal(site.address_line1||'')}" required /></label>
            <label>City <input name="city" value="${escapeVal(site.city||'')}" required /></label>
          </div>
          <div class="row">
            <label>State <input name="state" value="${escapeVal(site.state||'MA')}" /></label>
            <label>Risk score <input name="risk_score" type="number" min="0" max="5" value="${site.risk_score??''}" /></label>
          </div>
          <div class="row">
            <label>Latitude <input name="latitude" type="number" step="any" value="${site.latitude??''}" /></label>
            <label>Longitude <input name="longitude" type="number" step="any" value="${site.longitude??''}" /></label>
          </div>
          <div class="row">
            <label>Occupancy <input name="occupancy_type" value="${escapeVal(site.occupancy_type||'')}" /></label>
            <label>Construction <input name="construction_type" value="${escapeVal(site.construction_type||'')}" /></label>
          </div>
          <div class="row">
            <label>Stories <input name="stories" type="number" value="${site.stories??''}"/></label>
            <label>Square feet <input name="square_feet" type="number" value="${site.square_feet??''}"/></label>
          </div>
          <div class="row">
            <label>Sprinklered <select name="sprinklered"><option value="false" ${site.sprinklered?'':'selected'}>No</option><option value="true" ${site.sprinklered?'selected':''}>Yes</option></select></label>
            <label>Standpipe <select name="standpipe"><option value="false" ${site.standpipe?'':'selected'}>No</option><option value="true" ${site.standpipe?'selected':''}>Yes</option></select></label>
          </div>
          <div class="row">
            <label>Alarm present <select name="alarm_present"><option value="true" ${site.alarm_present?'selected':''}>Yes</option><option value="false" ${site.alarm_present?'':'selected'}>No</option></select></label>
            <label>Alarm company <input name="alarm_company" value="${escapeVal(site.alarm_company||'')}" /></label>
          </div>
          <div class="row">
            <label>Alarm panel location <input name="alarm_panel_location" value="${escapeVal(site.alarm_panel_location||'')}" /></label>
            <label>FDC type <input name="fdc_type" value="${escapeVal(site.fdc_type||'')}" /></label>
          </div>
          <div class="row">
            <label>FDC location <input name="fdc_location" value="${escapeVal(site.fdc_location||'')}" /></label>
            <label>Knox box location <input name="knox_box_location" value="${escapeVal(site.knox_box_location||'')}" /></label>
          </div>
          <div class="row">
            <label>Gas shutoff location <input name="gas_shutoff_location" value="${escapeVal(site.gas_shutoff_location||'')}" /></label>
            <label>Electric shutoff location <input name="electric_shutoff_location" value="${escapeVal(site.electric_shutoff_location||'')}" /></label>
          </div>
          <div class="row">
            <label>Water shutoff location <input name="water_shutoff_location" value="${escapeVal(site.water_shutoff_location||'')}" /></label>
            <label>Roof access <input name="roof_access" value="${escapeVal(site.roof_access||'')}" /></label>
          </div>
          <label>Special instructions <textarea name="special_instructions">${escapeVal(site.special_instructions||'')}</textarea></label>
        </form>`;
    }(site, hazards, water, docs){
      // Build a compact edit form for core site fields only (related tables managed elsewhere)
      return `
        <form id="editForm" class="grid">
          <div class="row">
            <label>Name <input name="name" value="${escapeVal(site.name)}" required /></label>
            <label>Status
              <select name="status">
                ${['draft','in_review','approved'].map(s=>`<option ${site.status===s?'selected':''}>${s}</option>`).join('')}
              </select>
            </label>
          </div>
          <div class="row">
            <label>Address 1 <input name="address_line1" value="${escapeVal(site.address_line1||'')}" required /></label>
            <label>City <input name="city" value="${escapeVal(site.city||'')}" required /></label>
          </div>
          <div class="row">
            <label>State <input name="state" value="${escapeVal(site.state||'MA')}" /></label>
            <label>Risk score <input name="risk_score" type="number" min="0" max="5" value="${site.risk_score??''}" /></label>
          </div>
          <div class="row">
            <label>Latitude <input name="latitude" type="number" step="any" value="${site.latitude??''}" /></label>
            <label>Longitude <input name="longitude" type="number" step="any" value="${site.longitude??''}" /></label>
          </div>
          <div class="row">
            <label>Occupancy <input name="occupancy_type" value="${escapeVal(site.occupancy_type||'')}" /></label>
            <label>Construction <input name="construction_type" value="${escapeVal(site.construction_type||'')}" /></label>
          </div>
          <label>Special instructions <textarea name="special_instructions">${escapeVal(site.special_instructions||'')}</textarea></label>
        </form>
        <p class="hint">Related tables (hazards, water, documents) aren’t edited here; we’ll add dedicated editors next if you want.</p>
      `;
    }

    saveEdit.onclick = async ()=>{
      const form = document.getElementById('editForm');
      if (!form) return;
      const f = Object.fromEntries(new FormData(form).entries());
      // Cast numbers
      for (const k of ['risk_score','latitude','longitude']){
        if (f[k] === '' || f[k] === null) f[k] = null; else f[k] = Number(f[k]);
      }
      const { error } = await supabase.from('sites').update(f).eq('id', currentSiteId);
      if (error){ alert(error.message); return; }
      dlg.close();
      loadPage(page);
    };

    deleteSiteBtn.onclick = async ()=>{
      if (!currentSiteId) return;
      if (!confirm('Delete this site? This also deletes related hazards/water/docs (ON DELETE CASCADE).')) return;
      const { error } = await supabase.from('sites').delete().eq('id', currentSiteId);
      if (error){ alert(error.message); return; }
      dlg.close();
      loadPage(0);
    };

    // === Utils ===
    function escapeHtml(s = ''){
      // simpler, no inline object literal (avoids any parser edge-cases)
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }[m]));
    }
    function escapeVal(s = ''){
      return escapeHtml(String(s));
    }
  </script>
</body>
</html>

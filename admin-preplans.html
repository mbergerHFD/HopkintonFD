<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HFD Preplans Admin</title>
  <style>
    :root {
      --bg:#0b1220; --card:#111827; --muted:#6b7280; --text:#e5e7eb; --accent:#60a5fa; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    html,body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    header { position:sticky; top:0; z-index:10; backdrop-filter:saturate(180%) blur(8px); background:rgba(11,18,32,.8); border-bottom:1px solid #1f2937; }
    header .wrap { max-width:1100px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; gap:14px; }
    header h1 { font-size:18px; margin:0; letter-spacing:.4px; }
    main { max-width:1100px; margin:0 auto; padding:18px 16px 40px; }

    .card { background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; }
    .grid { display:grid; gap:12px; }

    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:700px){ .row{ grid-template-columns:1fr; } }

    label { display:grid; gap:6px; font-size:14px; color:#cbd5e1; }
    input, select, textarea { background:#0f172a; color:var(--text); border:1px solid #243045; border-radius:10px; padding:10px 12px; font:inherit; }
    textarea { min-height:80px; }
    button { background:#0f172a; color:var(--text); border:1px solid #243045; border-radius:10px; padding:10px 12px; cursor:pointer; }
    button.primary { background:var(--accent); color:#08101d; border-color:transparent; }
    button.ghost { background:transparent; border-color:#334155; }
    button.warn { background:var(--warn); color:#0b0b0b; border-color:transparent; }
    button.bad { background:var(--bad); color:#0b0b0b; border-color:transparent; }

    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .toolbar .grow { flex:1 1 auto; min-width:200px; }

    table { width:100%; border-collapse:collapse; font-size:14px; }
    thead th { text-align:left; font-weight:600; color:#cbd5e1; border-bottom:1px solid #1f2937; padding:10px 8px; white-space:nowrap; }
    tbody td { border-bottom:1px solid #1f2937; padding:10px 8px; vertical-align:top; }
    tbody tr:hover { background:#0f172a; }
    .badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #334155; }
    .badge.approved { background:rgba(16,185,129,.12); border-color:rgba(16,185,129,.35); color:#86efac; }
    .badge.in_review { background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:#fde68a; }
    .badge.draft { background:rgba(59,130,246,.12); border-color:rgba(59,130,246,.35); color:#93c5fd; }

    .muted { color:var(--muted); }
    .pill { padding:6px 10px; border-radius:999px; border:1px solid #2b3a55; background:#0f172a; }

    .flex { display:flex; gap:10px; align-items:center; }
    .right { margin-left:auto; }

    dialog.modal { width:min(900px, 92vw); border:none; border-radius:16px; padding:0; background:#0b1220; color:var(--text); }
    .modal__header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #1f2937; position:sticky; top:0; background:#0b1220; }
    .modal__body { padding:16px; max-height:min(70vh, 70svh); overflow:auto; }
    .modal__footer { padding:12px 16px; border-top:1px solid #1f2937; display:flex; gap:8px; justify-content:flex-end; }

    .hint { font-size:13px; color:#9aa5b1; }
    .spacer { height:12px; }
      .tabs { display:flex; gap:6px; border-bottom:1px solid #1f2937; margin-bottom:12px; }
    .tabs button { padding:8px 10px; border:1px solid #2b3a55; background:#0f172a; color:var(--text); border-bottom:none; border-radius:10px 10px 0 0; cursor:pointer; }
    .tabs button.active { background:#111827; }
    .tabpanel { display:none; }
    .tabpanel.active { display:block; }
    .mini-table { width:100%; border-collapse:collapse; font-size:14px; }
    .mini-table th, .mini-table td { border-bottom:1px solid #1f2937; padding:8px 6px; text-align:left; vertical-align:top; }
    .uploader { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>HFD Preplans Admin</h1>
      <div class="right flex" id="userBar" hidden>
        <span id="whoami" class="muted"></span>
        <button id="logoutBtn" class="ghost">Sign out</button>
      </div>
    </div>
  </header>

  <main>
    <!-- AUTH -->
    <section id="authCard" class="card grid">
      <h2>Sign in</h2>
      <form id="signInForm" class="grid">
        <div class="row">
          <label>Email <input type="email" name="email" required /></label>
          <label>Password <input type="password" name="password" required /></label>
        </div>
        <div class="flex">
          <button class="primary">Sign in</button>
          <span id="authMsg" class="hint"></span>
        </div>
      </form>
      <p class="hint">Create users in Supabase → Auth → Users. This page uses your Supabase Auth and Row Level Security.</p>
    </section>

    <!-- SEARCH & REVIEW -->
    <section id="reviewCard" class="card grid" hidden>
      <div class="toolbar">
        <input id="q" class="grow" placeholder="Search name or address…" />
        <select id="status">
          <option value="">All statuses</option>
          <option value="approved">Approved</option>
          <option value="in_review">In review</option>
          <option value="draft">Draft</option>
        </select>
        <input id="city" placeholder="City (optional)" />
        <select id="sort">
          <option value="name">Sort: Name</option>
          <option value="city">Sort: City</option>
          <option value="last_reviewed">Sort: Last reviewed</option>
          <option value="risk_score">Sort: Risk score</option>
          <option value="id">Sort: ID</option>
        </select>
        <select id="dir">
          <option value="asc">Asc</option>
          <option value="desc">Desc</option>
        </select>
        <button id="searchBtn" class="primary">Search</button>
      </div>

      <div class="spacer"></div>

      <div class="flex">
        <div class="muted" id="count"></div>
        <div class="right flex">
          <button id="prevPage" class="ghost" disabled>Prev</button>
          <button id="nextPage" class="ghost" disabled>Next</button>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="tableWrap">
        <table id="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>City</th>
              <th>Status</th>
              <th>Risk</th>
              <th>Last Reviewed</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- QUICK ADD SITE (optional) -->
    <section id="quickAdd" class="card grid" hidden>
      <h2>Quick add site</h2>
      <form id="siteForm" class="grid">
        <div class="row">
          <label>Site name <input name="name" required /></label>
          <label>Status
            <select name="status">
              <option>draft</option>
              <option>in_review</option>
              <option>approved</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label>Address 1 <input name="address_line1" required /></label>
          <label>City <input name="city" required /></label>
        </div>
        <div class="row">
          <label>Latitude <input name="latitude" type="number" step="any" /></label>
          <label>Longitude <input name="longitude" type="number" step="any" /></label>
        </div>
        <div class="row">
          <label>Occupancy <input name="occupancy_type" /></label>
          <label>Construction <input name="construction_type" /></label>
        </div>
        <label>Special Instructions <textarea name="special_instructions"></textarea></label>
        <div class="flex">
          <button class="primary">Save Site</button>
          <span id="siteMsg" class="hint"></span>
        </div>
      </form>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Supabase project credentials
    const SUPABASE_URL = "https://loppyxebzoyrcgqwdxee.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxvcHB5eGViem95cmNncXdkeGVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5NjAwNDMsImV4cCI6MjA3NTUzNjA0M30.syk6wL25hBg5enkaI6oTbfAcoKNuvXdyRO8IHQT9X5c";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === Search Controls ===
    document.getElementById('searchBtn').onclick = () => loadPage(0); // Trigger search on click
    document.getElementById('q').addEventListener('keydown', (e) => { if (e.key === 'Enter') loadPage(0); }); // Trigger on Enter key
    document.getElementById('status').onchange = () => loadPage(0); // Trigger on status change
    document.getElementById('city').addEventListener('keydown', (e) => { if (e.key === 'Enter') loadPage(0); }); // Trigger on city input change
    document.getElementById('sort').onchange = () => loadPage(0); // Trigger on sort change
    document.getElementById('dir').onchange = () => loadPage(0); // Trigger on sort direction change

    async function loadPage(p) {
      const PAGE_SIZE = 25;
      let page = p;
      const from = p * PAGE_SIZE;
      const to = from + PAGE_SIZE - 1;

      let query = supabase.from('sites')
        .select('id,name,city,status,risk_score,last_reviewed,address_line1', { count: 'exact' });

      // Apply filters
      const text = document.getElementById('q').value.trim();
      if (text) {
        const pat = `%${escapeLike(text)}%`;
        query = query.or(`name.ilike.${pat},address_line1.ilike.${pat},city.ilike.${pat}`);
      }
      const st = document.getElementById('status').value.trim();
      if (st) query = query.eq('status', st);
      const c = document.getElementById('city').value.trim();
      if (c) query = query.ilike('city', `%${escapeLike(c)}%`);

      // Sorting
      const sortCol = document.getElementById('sort').value;
      const ascending = document.getElementById('dir').value === 'asc';
      query = query.order(sortCol, { ascending });

      // Range / pagination
      query = query.range(from, to);

      const { data, error, count } = await query;
      if (error) {
        console.error("Error fetching data", error);
        return;
      }

      renderRows(data, count);
    }

    function escapeLike(val) {
      return String(val).replace(/[%_]/g, '\\$&');
    }

    function renderRows(rows, totalCount) {
      const tbody = document.querySelector('#table tbody');
      tbody.innerHTML = '';
      if (!rows || rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No results found</td></tr>';
        return;
      }

      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${row.name}</td>
          <td>${row.city}</td>
          <td>${row.status}</td>
          <td>${row.risk_score}</td>
          <td>${row.last_reviewed ? new Date(row.last_reviewed).toLocaleDateString() : '—'}</td>
          <td><button class="ghost">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Update result count
      document.getElementById('count').textContent = `${totalCount} results`;
    }
  </script>
</body>
</html>
